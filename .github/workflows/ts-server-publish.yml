name: å‘å¸ƒ TypeScript Server åˆ° GHCR

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'server/ts/**'
      - '.github/workflows/ts-server-publish.yml'
      - '.github/actions/reusable-docker-build.yml'
    tags:
      - 'v*'
      - 'ts-server-v*'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'server/ts/**'
      - '.github/workflows/ts-server-publish.yml'
  workflow_dispatch:
    inputs:
      platforms:
        description: 'æž„å»ºå¹³å°ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string

# ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: ts-server-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-ts-server:
    name: æž„å»ºå¹¶å‘å¸ƒ TypeScript Server
    uses: ./.github/actions/reusable-docker-build
    with:
      service-name: 'TypeScript Server'
      service-path: 'server/ts'
      image-name: 'petcode-ts-server'
      platforms: ${{ inputs.platforms || 'linux/amd64,linux/arm64' }}
      node-version: '22'
    secrets: inherit

  # å¯é€‰ï¼šéƒ¨ç½²åŽçš„é›†æˆæµ‹è¯•
  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: publish-ts-server
    if: github.event_name != 'pull_request'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ‹‰å–å¹¶æµ‹è¯•é•œåƒ
        run: |
          echo "ðŸ” æ‹‰å–åˆšæž„å»ºçš„é•œåƒ..."
          IMAGE_TAG=$(echo "${{ needs.publish-ts-server.outputs.image-tags }}" | head -n 1)
          echo "ä½¿ç”¨é•œåƒæ ‡ç­¾: $IMAGE_TAG"

          docker pull $IMAGE_TAG

          echo "ðŸš€ å¯åŠ¨å®¹å™¨..."
          docker run -d --name petcode-test -p 8080:8080 $IMAGE_TAG

          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10

          echo "ðŸ§ª æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹..."
          if curl -f http://localhost:8080/health || curl -f http://localhost:8080/ ; then
            echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            docker logs petcode-test
            exit 1
          fi

          echo "ðŸ§¹ æ¸…ç†..."
          docker stop petcode-test
          docker rm petcode-test

      - name: è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "## âœ… TypeScript Server éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ‰ é›†æˆæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "é•œåƒå·²æˆåŠŸå‘å¸ƒåˆ° GitHub Container Registry å¹¶é€šè¿‡é›†æˆæµ‹è¯•ã€‚" >> $GITHUB_STEP_SUMMARY

