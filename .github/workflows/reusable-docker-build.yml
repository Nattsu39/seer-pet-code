name: å¯é‡ç”¨çš„ Docker æž„å»ºå’Œå‘å¸ƒå·¥ä½œæµ

on:
  workflow_call:
    inputs:
      branch:
        description: 'åˆ†æ”¯åç§°ï¼ˆä¾‹å¦‚ï¼šmain, master, developï¼‰'
        required: true
        type: string
      service-name:
        description: 'æœåŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šts-server, py-serverï¼‰'
        required: true
        type: string
      service-path:
        description: 'æœåŠ¡çš„ç›¸å¯¹è·¯å¾„ï¼ˆä¾‹å¦‚ï¼šserver/tsï¼‰'
        required: true
        type: string
      image-name:
        description: 'Docker é•œåƒåç§°ï¼ˆä¾‹å¦‚ï¼špetcode-ts-serverï¼‰'
        required: true
        type: string
      platforms:
        description: 'æž„å»ºå¹³å°ï¼ˆä¾‹å¦‚ï¼šlinux/amd64,linux/arm64ï¼‰'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      build-args:
        description: 'Docker æž„å»ºå‚æ•°ï¼ˆä¾‹å¦‚ï¼šARG1=value1,ARG2=value2ï¼‰'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js ç‰ˆæœ¬ï¼ˆç”¨äºŽä¾èµ–å®‰è£…å’Œæµ‹è¯•ï¼‰'
        required: false
        type: string
        default: '20'
    outputs:
      image-tags:
        description: 'ç”Ÿæˆçš„é•œåƒæ ‡ç­¾åˆ—è¡¨'
        value: ${{ jobs.build-and-push.outputs.tags }}
      image-digest:
        description: 'é•œåƒçš„ digest'
        value: ${{ jobs.build-and-push.outputs.digest }}

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      digest: ${{ steps.build-push.outputs.digest }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js çŽ¯å¢ƒï¼ˆå¦‚æžœéœ€è¦ï¼‰
        if: ${{ inputs.node-version != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.service-path }}/package-lock.json

      - name: å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆç”¨äºŽ monorepo å…±äº«ä¾èµ–ï¼‰
        if: ${{ inputs.node-version != '' }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          fi

      - name: ç”Ÿæˆ OpenAPI æ–‡æ¡£
        run: |
          cp openapi.yaml ${{ inputs.service-path }}/openapi.yaml

      - name: è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if: ${{ inputs.node-version != '' }}
        working-directory: ${{ inputs.service-path }}
        run: |
          npm ci
          if npm run | grep -q "test"; then
            npm test || echo "æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æž„å»º..."
          fi

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image-name }}
          tags: |
            # åˆ†æ”¯åæ ‡ç­¾
            type=ref,event=branch
            # PR æ ‡ç­¾
            type=ref,event=pr
            # è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # Git SHA çŸ­æ ‡ç­¾
            type=sha,prefix={{branch}}-,format=short
            # æœ€æ–°æ ‡ç­¾ï¼ˆä»…ç”¨äºŽ main/master åˆ†æ”¯ï¼‰
            type=raw,value=latest,enable={{is_default_branch}}
            # å¸¦æ—¶é—´æˆ³çš„æ ‡ç­¾ï¼ˆç”¨äºŽè¿½è¸ªï¼‰
            type=raw,value={{date 'YYYYMMDD-HHmmss' tz='Asia/Shanghai'}}
          labels: |
            org.opencontainers.image.title=${{ inputs.service-name }}
            org.opencontainers.image.description=PetCode ${{ inputs.service-name }}
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            maintainer=${{ github.repository_owner }}

      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.service-path }}
          file: ${{ inputs.service-path }}/Dockerfile
          platforms: ${{ inputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ inputs.build-args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸš€ Docker é•œåƒæž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æœåŠ¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡åç§°**: ${{ inputs.service-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡è·¯å¾„**: ${{ inputs.service-path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: ${{ inputs.image-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ é•œåƒæ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” é•œåƒæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.build-push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æ‹‰å–å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image-name }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

